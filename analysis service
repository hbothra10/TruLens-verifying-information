interface FactCheckResult {
  claim: string;
  verdict: string;
  explanation: string;
  correctedStatement?: string;
  sources: Array<{
    name: string;
    url: string;
    credibility: string;
  }>;
}

interface AnalysisResult {
  authenticityScore: number;
  isAuthentic: boolean;
  isWarning: boolean;
  detectionMetrics: Array<{
    label: string;
    score: number;
  }>;
  findings: string[];
  recommendation: string;
  analysisTime: string;
  detectedLanguage?: string;
  factCheck?: FactCheckResult;
}

export async function analyzeText(text: string): Promise<AnalysisResult> {
  const apiUrl = `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/analyze-content`;

  const response = await fetch(apiUrl, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${import.meta.env.VITE_SUPABASE_ANON_KEY}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      type: 'text',
      content: text,
    }),
  });

  if (!response.ok) {
    throw new Error('Failed to analyze text');
  }

  return await response.json();
}

export async function analyzeMedia(file: File): Promise<AnalysisResult> {
  const apiUrl = `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/analyze-content`;

  const fileContent = await fileToBase64(file);

  const response = await fetch(apiUrl, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${import.meta.env.VITE_SUPABASE_ANON_KEY}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      type: 'media',
      content: fileContent,
      fileName: file.name,
      fileType: file.type,
    }),
  });

  if (!response.ok) {
    throw new Error('Failed to analyze media');
  }

  return await response.json();
}

export async function analyzeURL(url: string): Promise<AnalysisResult> {
  const apiUrl = `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/analyze-content`;

  const response = await fetch(apiUrl, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${import.meta.env.VITE_SUPABASE_ANON_KEY}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      type: 'url',
      content: url,
    }),
  });

  if (!response.ok) {
    throw new Error('Failed to analyze URL');
  }

  return await response.json();
}

function fileToBase64(file: File): Promise<string> {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result as string);
    reader.onerror = error => reject(error);
  });
}
